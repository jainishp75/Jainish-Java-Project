<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>All Movies</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" 
          rel="stylesheet" 
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" 
          crossorigin="anonymous">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f9fafb;
            margin: 30px;
            color: #333;
        }
        h1 {
            color: #2c3e50;
        }
        input[type="text"], select {
            width: 300px;
            padding: 8px 12px;
            margin-bottom: 20px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 1em;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            background-color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #34495e;
            color: #ecf0f1;
            font-weight: 600;
        }
        tr:hover {
            background-color: #f1f1f1;
        }
        .poster-img {
            max-width: 80px;
            border-radius: 4px;
        }
        .no-movies-row {
            font-weight: bold;
            text-align: center;
            color: #c0392b;
        }
        .pagination {
            margin-top: 20px;
            text-align: center;
        }
        .pagination button {
            background-color: #34495e;
            border: none;
            color: white;
            padding: 8px 16px;
            margin: 0 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        .pagination button:disabled {
            background-color: #7f8c8d;
            cursor: default;
        }
        .pagination span {
            font-weight: 600;
            margin: 0 10px;
            color: #2c3e50;
        }
        .btn {
            margin-right: 5px;
        }
    </style>
</head>
<body>

<h1>All Movies</h1>
<label for="pageSizeSelect">Movies per page:</label>
<select id="pageSizeSelect">
    <option th:selected="${size == 2}" value="2">2</option>
    <option th:selected="${size == 5}" value="5">5</option>
    <option th:selected="${size == 10}" value="10">10</option>
    <option th:selected="${size == 20}" value="20">20</option>
</select>
<input type="text" id="searchInput" placeholder="Search movies by title..." />

<table>
    <thead>
        <tr>
            <th>Sr No.</th>
            <th>Poster</th>
            <th>Title</th>
            <th>Original Title</th>
            <th>Overview</th>
            <th>Release Date</th>
            <th>Rating</th>
            <th>Adult</th>
            <th>Language</th>
            <th>Popularity</th>
            <th>Vote Count</th>
            <th>Operations</th>
			<th>Favourite Status</th>
        </tr>
    </thead>
    <tbody id="moviesTbody">
        <tr th:each="movie, stat : ${movies}" class="movie-row">
            <td th:text="${stat.index + 1}">1</td>
            <td>
                <img class="poster-img" th:src="@{'https://image.tmdb.org/t/p/w200' + ${movie.posterPath}}" alt="Poster" />
            </td>
            <td class="title-cell" th:text="${movie.title}">Title</td>
            <td th:text="${movie.originalTitle}">Original Title</td>
            <td th:text="${movie.overview}">Overview</td>
            <td th:text="${movie.releaseDate}">Release Date</td>
            <td th:text="${movie.rating}">Rating</td>
            <td th:text="${movie.adult ? 'Yes' : 'No'}">Adult</td>
            <td th:text="${movie.originalLanguage}">Language</td>
            <td th:text="${movie.popularity}">Popularity</td>
            <td th:text="${movie.voteCount}">Vote Count</td>
            <td>
                <!-- Delete Button -->
                <form th:action="@{/deleteMovie/{id}(id=${movie.id})}" method="post" 
                      onsubmit="return confirm('Are you sure you want to delete this movie?');" style="display:inline;">
                    <input type="hidden" name="_method" value="put"/>
                    <button class="btn btn-danger" type="submit">Delete</button>
                </form>

            </td>
			
			
				<!-- Favourite / Unfavourite Buttons -->
				<td>
				    <button class="btn btn-warning" 
				            th:id="'favBtn-' + ${movie.id}" 
				            th:style="${movie.isFavourite} ? 'display:none' : 'inline-block'" 
				            th:onclick="'toggleFavourite(' + ${movie.id} + ', true)'">
				        Favourite
				    </button>

				    <button class="btn btn-success" 
				            th:id="'unfavBtn-' + ${movie.id}" 
				            th:style="${movie.isFavourite} ? 'inline-block' : 'display:none'" 
				            th:onclick="'toggleFavourite(' + ${movie.id} + ', false)'">
				        Unfavourite
				    </button>
				</td>

			
        </tr>
    </tbody>
</table>

<div class="pagination"> 
    <button th:if="${currentPage > 0}"
            th:onclick="'window.location=\'/fetchALL?page=' + (${currentPage} - 1) + '&size=' + ${size} + '\''">
        Previous
    </button>

    <span>Page <b th:text="${currentPage + 1}">1</b> of <b th:text="${totalPages}">1</b></span>

    <button th:if="${currentPage + 1 < totalPages}"
            th:onclick="'window.location=\'/fetchALL?page=' + (${currentPage} + 1) + '&size=' + ${size} + '\''">
        Next
    </button>
</div>

<script>
    // Search functionality
    const searchInput = document.getElementById('searchInput');
    const tbody = document.getElementById('moviesTbody');

    searchInput.addEventListener('input', () => {
        const filter = searchInput.value.trim().toLowerCase();
        const rows = tbody.querySelectorAll('tr.movie-row');
        let visibleCount = 0;

        rows.forEach(row => {
            const titleCell = row.querySelector('.title-cell');
            if (!titleCell) return;
            const titleText = titleCell.textContent.toLowerCase();
            if (titleText.includes(filter) || filter === "") {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        const noMoviesRow = tbody.querySelector('.no-movies-row');
        if (noMoviesRow) noMoviesRow.remove();

        if (visibleCount === 0) {
            const noRow = document.createElement('tr');
            noRow.classList.add('no-movies-row');
            noRow.innerHTML = `<td colspan="12">Movies not found</td>`;
            tbody.appendChild(noRow);
        }
    });

    // Page size change
    const pageSizeSelect = document.getElementById('pageSizeSelect');
    pageSizeSelect.addEventListener('change', () => {
        const selectedSize = pageSizeSelect.value;
        window.location = `/fetchALL?page=0&size=${selectedSize}`;
    });

    // Favourite / Unfavourite API call
	function toggleFavourite(movieId, makeFavourite) {
	    const url = makeFavourite 
	        ? `/favouriteMovie/${movieId}` 
	        : `/unFavouriteMovie/${movieId}`;

	    fetch(url, { method: 'PUT' })
	        .then(res => {
	            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
	            return res.json();  // parse JSON
	        })
	        .then(data => {
	            console.log(data); // {statusCode: 200, message: "...", movieEntity: null}

	            if (data.statusCode === 200) {  // <-- use statusCode, not status
	                const favBtn = document.getElementById(`favBtn-${movieId}`);
	                const unfavBtn = document.getElementById(`unfavBtn-${movieId}`);
	                if (makeFavourite) {
	                    favBtn.style.display = 'none';
	                    unfavBtn.style.display = 'inline-block';
	                } else {
	                    unfavBtn.style.display = 'none';
	                    favBtn.style.display = 'inline-block';
	                }
	            } else {
	                alert(`Error: ${data.message}`);
	            }
	        })
	        .catch(err => {
	            console.error('Error:', err);
	            alert('Error updating favourite status: ' + err.message);
	        });
	}





</script>

</body>
</html>
